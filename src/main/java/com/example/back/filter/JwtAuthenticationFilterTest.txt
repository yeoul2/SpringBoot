package com.example.back.filter;

import java.io.IOException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import com.example.back.service.JWTService;
import com.example.back.service.UserService;
import io.jsonwebtoken.ExpiredJwtException;
import io.micrometer.common.util.StringUtils;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.log4j.Log4j2;

//JWT ê¸°ë°˜ ì¸ì¦ì„ ì²˜ë¦¬í•˜ê¸°ìœ„í•œ Spring Security ì»¤ìŠ¤í…€ í•„í„° ì…ë‹ˆë‹¤.
//OncePerRequestFilterë¥¼ ìƒì† ë°›ì•„ ìš”ì²­ ë‹¹ í•œ ë²ˆì”© í•„í„°ê°€ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
//ìŠ¤í”„ë§ì—ì„œëŠ” setterê°ì²´ ì£¼ì…ë²•ê³¼ ìƒì„±ì ê°ì²´ ì£¼ì…ë²•ì´ ìˆë‹¤.
@Log4j2
@Component //ì´ í´ë˜ìŠ¤ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡. ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ ì„¤ì •ì—ì„œ ì£¼ì…ë°›ì•„ ì‚¬ìš©ì´ ê°€ëŠ¥í•¨.
@RequiredArgsConstructor //finalë¡œ ì„ ì–¸ëœ í•„ë“œì— ëŒ€í•œ ìƒì„±ìë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì—¬ ì˜ì¡´ì„± ì£¼ì…ì„ í•´ì¤Œ.
public class JwtAuthenticationFilter extends OncePerRequestFilter{
    private final JWTService jwtService;
    private final UserService userService;
    //ì´ í•„í„°ì˜ í•µì‹¬ ë©”ì†Œë“œì´ë‹¤. - í•µì‹¬ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ” ë©”ì†Œë“œì´ë‹¤.
    //ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ë§ˆë‹¤ ì‹¤í–‰ì´ ë¨.
    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
        throws ServletException, IOException {
        

    // ì¸ì¦ì´ í•„ìš” ì—†ëŠ” ê²½ë¡œëŠ” ë°”ë¡œ ì§€ë‚˜ê°€ê²Œ ì²˜ë¦¬
    String path = request.getRequestURI();

    // âœ… OAuth2 ë¡œê·¸ì¸ ê²½ë¡œë„ í•„í„° ì œì™¸
    if (path.startsWith("/api/v1/auth/signup") || 
        path.startsWith("/api/v1/auth/signin") || 
        path.startsWith("/oauth2/authorization") || 
        path.startsWith("/login/oauth2/code")) {
        filterChain.doFilter(request, response);
        return;
    }

    // ê¸°ì¡´ JWT ì¸ì¦ ë¡œì§
    final String authHeader = request.getHeader("Authorization");
    log.info("ğŸ” [JwtAuthenticationFilter] ìš”ì²­ëœ Authorization í—¤ë”: {}", authHeader);
    final String jwt;
    final String userId;
    try {
        // authHeaderê°€ ë¹ˆê°’ì´ë©´ Bearerë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë©´ JWTê²€ì¦ ì—†ì´ ë‹¤ìŒ í•„í„°ë¡œ ë„˜ì–´ê°„ë‹¤.
        //if (StringUtils.isEmpty(authHeader) || !org.apache.commons.lang3.StringUtils.startsWith(authHeader, "Bearer")) {
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {    
            log.warn("âŒ Authorization í—¤ë” ì—†ìŒ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹: {}", authHeader);
            filterChain.doFilter(request, response);
            return;
        }
        // í—¤ë”ì— ìˆëŠ” Bearer ë’¤ì— ì‹¤ì œ JWTí† í° ë¬¸ìì—´ì„ ì¶”ì¶œí•˜ê¸°
        jwt = authHeader.substring(7); // ë¬¸ìì—´ì„ ìë¥¼ ë•Œ ì‚¬ìš©í•¨.
        // ì¶”ì¶œí•œ í† í°ì—ì„œ ì‚¬ìš©ì ì´ë¦„ì„ ì¶”ì¶œí•¨.
        userId = jwtService.extractUserName(jwt);

        log.info("âœ… [JwtAuthenticationFilter] JWT ì¶”ì¶œ ì™„ë£Œ - UserID: {}", userId);

        // userIdê°€ ì¡´ì¬í•˜ê³  í˜„ì¬ SecurityContextì— ì¸ì¦ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€ ì¸ì¦ì„ ìˆ˜í–‰í•¨
        if (StringUtils.isNotEmpty(userId) && SecurityContextHolder.getContext().getAuthentication() == null) {
            UserDetails userDetails = userService.userDetailsService().loadUserByUsername(userId);
            // jwtService.isTokenValid(jwt, userDetails)ë¥¼ í†µí•´ í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.
            if (jwtService.isTokenValid(jwt, userDetails)) {
                // ìƒˆ SecurityContext ìƒì„±í•˜ê³  ì‚¬ìš©ì ì •ë³´ì™€ ê¶Œí•œ ì •ë³´ë¥¼ ë‹´ì€ UsernamePasswordAuthenticationTokenì„ ìƒì„±í•¨.
                SecurityContext securityContext = SecurityContextHolder.createEmptyContext();
                UsernamePasswordAuthenticationToken token = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities()
                );
                // ìš”ì²­ì— ëŒ€í•œ ì„¸ë¶€ ì •ë³´ë¥¼ í† í°ì— ì¶”ê°€í•œ ë’¤ ì´ í† í°ì„ SecurityContextì— ì„¤ì •í•¨.
                token.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                securityContext.setAuthentication(token);
                // ìµœì¢…ì ìœ¼ë¡œ SecurityContextHolderì— ì €ì¥í•¨.
                SecurityContextHolder.setContext(securityContext);
                log.info("âœ… JWT ì¸ì¦ ì„±ê³µ - User: {}", userId);
            }
        } // ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬
    } catch (ExpiredJwtException e) { // ì˜ˆì™¸ì²˜ë¦¬: í† í° ë§Œë£Œ
        log.info("í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.getWriter().write("í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤");
        return;
    }
    // ë‹¤ìŒ í•„í„° ì²´ì¸ì„ ê³„ì† ì‹¤í–‰ì‹œí‚´
    filterChain.doFilter(request, response);
    }

    

}//end of JwtAuthenticationFilter
/*
 * 1. Authorization í—¤ë” ì²˜ë¦¬
 * 
 * 2. JWTí† í° ê²€ì¦
 * 
 * 3. JWT ì¶”ì¶œ ë° ì‚¬ìš©ì ì‹ë³„
 * 
 * 4. ì‚¬ìš©ì ì¸ì¦ì²˜ë¦¬
 * 
 * 5. ì˜ˆì™¸ì²˜ë¦¬ : í† í° ë§Œë£Œ
 * 
 * 
 * 6. í•„í„° ì²´ì¸ ê³„ì† ì‹¤í–‰
 * 
 * 
 * 
 */